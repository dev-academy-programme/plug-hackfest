
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Free Money Sample Solution Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../plug-intro.html" />
    
    
    <link rel="prev" href="free-money-overview.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../learning-tips.html">
            
                <a href="../../learning-tips.html">
            
                    
                    Learning Tips
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../learning/learning-plan.html">
            
                <a href="../learning/learning-plan.html">
            
                    
                    Make a learning plan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../learning/5-rs.html">
            
                <a href="../learning/5-rs.html">
            
                    
                    The 5 Rs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../setup.html">
            
                <a href="../../setup.html#setting-up-your-environment">
            
                    
                    Setting up your Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../plug-intro.html">
            
                <a href="../../plug-intro.html">
            
                    
                    An introduction to Plug
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../plug-intro.html">
            
                <a href="../../plug-intro.html#quickstart">
            
                    
                    Quickstart
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../plug-intro.html">
            
                <a href="../../plug-intro.html#balance-tutorial">
            
                    
                    Balance Tutorial
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="free-money-overview.html">
            
                <a href="free-money-overview.html">
            
                    
                    Free Money Challenge
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.4" data-path="free-money-solution.html">
            
                <a href="free-money-solution.html">
            
                    
                    Free Money Sample Solution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../../plug-intro.html">
            
                <a href="../../plug-intro.html#decide-what-to-do-next">
            
                    
                    Next Steps
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Free Money Sample Solution</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="free-money-challenge-solution">Free Money Challenge Solution</h1>
<p>This page outlines some potential solutions for the <a href="">Free Money Challenge</a>.
The sample solution code walks through creating a &quot;UnexpectedExpense&quot; Transform, which subtracts some money from a specific User. The solutions can be reworked to help you solve the Free Money Challenge.</p>
<h4 id="writing-the-unexpectedexpense-transform">Writing the UnexpectedExpense transform.</h4>
<p>At the top of your UnexpectedExpense function, you must initialize all of the local properties. These properties will all be set once the object is packed into the registry.</p>
<pre><code class="lang-python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UnexpectedExpense</span><span class="hljs-params">(Transform)</span>:</span>
    fqdn = <span class="hljs-string">&quot;tutorial.UnexpectedExpense&quot;</span>
    user: str
    amount: int
</code></pre>
<p> This next part of the class is fairly boilerplate, and will look similar across most of the Transforms you will write. It specifies the different authorizations, models and keys required to perform the Transform - as well as instructions for how to handle packing/unpacking the object.</p>
<pre><code class="lang-python">    ...

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">required_authorizations</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> {self.user}

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">required_models</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">return</span> {BalanceModel.fqdn}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">required_keys</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> {self.user}

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pack</span><span class="hljs-params">(registry, obj)</span>:</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;user&quot;</span>: obj.user,
            <span class="hljs-string">&quot;amount&quot;</span>: obj.amount,
        }

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unpack</span><span class="hljs-params">(cls, registry, payload)</span>:</span>
        <span class="hljs-keyword">return</span> cls(
            receiver=payload[<span class="hljs-string">&quot;user&quot;</span>],
            amount=payload[<span class="hljs-string">&quot;amount&quot;</span>],
        )
</code></pre>
<p>The final required methods are the <code>verify()</code> and <code>apply()</code>. They handle the actual business logic of the script. Most of the action inside a Transform will generally take place inside these two functions.</p>
<pre><code class="lang-python">    ...

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">verify</span><span class="hljs-params">(self, state_slice)</span>:</span>
        balances = state_slice[BalanceModel.fqdn]

        <span class="hljs-keyword">if</span> self.amount &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> unexpected_expense.error.InvalidAmountError(<span class="hljs-string">&quot;Expense amount must be more than 0&quot;</span>)

        <span class="hljs-keyword">if</span> balances[self.user].balance &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> unexpected_expense.error.NotEnoughMoneyError(<span class="hljs-string">&quot;User is already broke&quot;</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span><span class="hljs-params">(self, state_slice)</span>:</span>
        balances = state_slice[BalanceModel.fqdn]
        balances[self.user].balance -= self.amount
</code></pre>
<p>This completes the transform. It&apos;s a very straight forward process if you actually just read it through line by line. It has a few properties, and some methods for packing/unpacking events, and verifying/applying transformations on the state.</p>
<h4 id="writing-the-unexpectedexpense-client">Writing the UnexpectedExpense client.</h4>
<p>The client side code is a bit more complex than the Transforms. There are two ways of going about it. We&apos;re going to do it the long way first, packing up and hashing our own objects, and then POSTing them to the backend API.</p>
<p>Here in <code>unexpected_expense.py</code>, we start by registering the unexpected expense event in the register. You will also need to create a new instance of the User class, and pass in the <code>signing_key_input</code> to make sure you get back the correct User object.</p>
<pre><code class="lang-python">...
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_unexpected_expense</span><span class="hljs-params">(signing_key_input)</span>:</span>
    registry = Registry().with_default()
    registry.register(Event)
    registry.register(UnexpectedExpense)

    user = <span class="hljs-keyword">await</span> User.load(signing_key_input)
</code></pre>
<p>Once that is done, we now have everything required to create a new instance of our UnexpectedExpense transform.</p>
<pre><code class="lang-python">...

  transform = UnexpectedExpense(
    user=user.address,
    amount=<span class="hljs-number">1000</span>,
    )
</code></pre>
<p>Now it&apos;s time for the complicated stuff. Fortunately, it&apos;s mostly just complicated for the computer. This block on <code>challenge</code>s, <code>proof</code>s and <code>transaction</code>s will look pretty similar in all of your client side code. And, other than tweaking a few minor details, you won&apos;t ever have to change much to get this working elsewhere.</p>
<pre><code class="lang-python">...

  challenge = transform.hash(sha256)
  proof = SingleKeyProof(user.address, user.nonce, challenge, <span class="hljs-string">&apos;challenge.UnexpectedExpense&apos;</span>)
  proof.sign(user.signing_key)
  transaction = Transaction(transform, {proof.address: proof})
</code></pre>
<p>Now that we have the <code>challenge</code>, <code>proof</code> and <code>transaction</code> objects all ready to go, it&apos;s time to pack them up into an <code>event</code>, and then into a <code>payload</code> to POST over HTTP to the api backend.</p>
<pre><code class="lang-python">    ...

    event = Event(
        event=TransactionEvent.ADD,
        payload=transaction
    )

    payload = registry.pack(event)
</code></pre>
<p>And finally, the transform event is all good to go, and ready to be sent off to the API. This block will finish off the script:</p>
<pre><code class="lang-python">    ...

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.post(<span class="hljs-string">&quot;http://localhost:8181/_api/v1/transaction&quot;</span>, json=payload) <span class="hljs-keyword">as</span> response:
            data = <span class="hljs-keyword">await</span> response.json()

            print(data)
</code></pre>
<p>Take a moment to read back over all of this code, and make sure that you understand everything that is happening along the way. First, the <code>User</code> object is instantiated. The User&apos;s <code>address</code> is then passed into the <code>UnexpectedExpense</code> transform that we wrote earlier. The transform is then hashed and turned into a <code>challenge</code>, which in turn is used to create the <code>proof</code>, which then gets signed with the Users <code>signing_key</code>. All of this comprises a <code>transaction</code>, which is then turned into an <code>event</code>. Finally, the event is packed into the <code>registry</code> and <code>payload</code>, and POSTed to the correct route.</p>
<p>It&apos;s a dense process, but one step logically follows on to another. If these concepts are very foreign to you, try checking out the <a href="../crypto/blockchain.md">resource on blockchain</a> in this module.</p>
<h4 id="using-the-plug-api-client">Using the Plug API Client.</h4>
<p>If you haven&apos;t already, head over to this page on the <a href="NaN">Plug API Client</a> and follow the setup instructions. All of the example code for using the API Client is lifted from the solution to the Free Money challenge.</p>
<p>Changing our current scripts to use the <code>api_client</code> is quite a bit of work, but it will lead to much cleaner, more manageable code.</p>
<h5 id="api-client-walkthrough">API Client Walkthrough</h5>
<p>All of the functionality you&apos;ll need to work with the api lives in the <code>client/utils.py</code> script. The <code>utils.py</code> file can be required in whenever we need to interact with the api_client. Let&apos;s look at an example of that now in <code>user.py</code>:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> client.utils <span class="hljs-keyword">import</span> get_api_client, get_key_manager
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> get_event_loop

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, address)</span>:</span>
        self.client = get_api_client()
        self.key_manager = get_key_manager()

        loop = get_event_loop()
        self.network_id = loop.run_until_complete(self.client.get_network_id())

        <span class="hljs-keyword">if</span> (address):
            self.address = address
        <span class="hljs-keyword">else</span>:
            self.address = self.key_manager.generate()
            self.key_manager.set_nonce(self.address, self.network_id, <span class="hljs-number">0</span>)
</code></pre>
<p>The entire class just looks like this now. The key manager handles the generation and local storage of the keys for us.
Next let&apos;s explore how the api_client is used to interact with our Transforms in <code>unexpected_expense_client.py</code>:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> unexpected_expense.transform <span class="hljs-keyword">import</span> UnexpectedExpense
<span class="hljs-keyword">from</span> client.utils <span class="hljs-keyword">import</span> register_transform_event
<span class="hljs-keyword">from</span> client.user <span class="hljs-keyword">import</span> User

<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> get_event_loop

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_unexpected_expense</span><span class="hljs-params">(client, address_input, amount)</span>:</span>
    register_transform_event(UnexpectedExpense)

    loop = get_event_loop()

    response = loop.run_until_complete(client.broadcast_transform(UnexpectedExpense(
        user=address_input,
        amount=int(amount),
    )))

    print(response)
    <span class="hljs-keyword">return</span> response
</code></pre>
<p><em>This</em> is really amazing. All of that complicated code from before doing the hashing and proofing and packaging; condensed down into a tight little function. The <code>broadcast_transform()</code> method does it all for us!</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="free-money-overview.html" class="navigation navigation-prev " aria-label="Previous page: Free Money Challenge">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../plug-intro.html#decide-what-to-do-next" class="navigation navigation-next " aria-label="Next page: Next Steps">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Free Money Sample Solution","level":"1.4.4","depth":2,"next":{"title":"Next Steps","level":"1.4.5","depth":2,"anchor":"#decide-what-to-do-next","path":"plug-intro.md","ref":"plug-intro.md#decide-what-to-do-next","articles":[]},"previous":{"title":"Free Money Challenge","level":"1.4.3","depth":2,"path":"segments/challenges/free-money-overview.md","ref":"segments/challenges/free-money-overview.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"3.x.x","theme":"default","variables":{"transforms":"/segments/plug/transforms.md","initial-state":"/segments/plug/initial-state.md","cookie-cutter":"/segments/plug/cookie-cutter.md","models":"/segments/plug/models.md","plug":"/segments/plug/","freeMoneyChallenge":"http://github.com/dev-academy-programme/plug-free-money-challenge/","blockchain":"/segments/crypto/blockchain.md","crypto-kiwis":"/crypto-kiwis.md/","decentralisation":"/segments/crypto/decentralisation.md","python":"/segments/python/","prerequisites":"/segments/plug/prerequisites.md","setup":"/segments/plug/setup.md","api-client":"/segments/plug/api-client.md"},"plugins":["collapsible-menu"],"pluginsConfig":{"fontSettings":{"theme":"night"},"collapsible-menu":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css"}},"file":{"path":"segments/challenges/free-money-solution.md","mtime":"2018-10-04T07:56:18.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2018-10-05T20:55:39.376Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

